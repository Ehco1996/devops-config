version: 1

tasks:
  - name: parser-generated
    taskType: common
    shellScript: |
      mv parser.go parser.go.committed
      make parser
      diff -u parser.go.committed parser.go
    buildEnv:
      image: golang:1.16

  - name: parser-integration-test 
    taskType: common
    shellScript: |
      cd ../
      JENKINS_WORKSPACE=$(pwd)
      git clone --depth=1 https://github.com/pingcap/tidb.git
      cd tidb
      rm go.sum
      GO111MODULE=on go mod edit -replace github.com/pingcap/parser=$JENKINS_WORKSPACE/parser
      go mod tidy
      make gotest
    buildEnv:
      image: golang:1.16

  - name: parser-format
    taskType: common
    shellScript: |
      make fmt
    buildEnv:
      image: golang:1.16


  - name: parser-ut
    taskType: unit-test
    shellScript: |
      make test
      
      GO111MODULE=off go get github.com/axw/gocov/gocov
      GO111MODULE=off go get github.com/jstemmer/go-junit-report
      GO111MODULE=off go get github.com/AlekSi/gocov-xml
      GO111MODULE=on go test -v -p 1 -race -covermode=atomic -coverprofile=cover.out -coverpkg=./... ./... | go-junit-report > test.xml
      gocov convert cover.out | gocov-xml > coverage.xml

    utReportDir: test.xml
    covReportDir: coverage.xml
    coverageRate: 80
    buildEnv:
      image: golang:1.16
      request:
        cpu: 4
        mem: 8Gi
      limit:
        cpu: 4
        mem: 8Gi